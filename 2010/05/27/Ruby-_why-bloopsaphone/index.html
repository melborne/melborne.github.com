
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    
      <title>Rubyでマリオを奏でよう！</title>
    
    
    <meta name="author" content="kyoendo" />

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter-ext/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/assets/themes/twitter-ext/css/style.css?body=1" rel="stylesheet" type="text/css" media="all" />
    <link href="/assets/themes/twitter-ext/css/syntax.css" rel="stylesheet" type="text/css" />
    <link href="/assets/themes/twitter-ext/css/lightbox.css" rel="stylesheet" />
    <link media="only screen and (max-device-width: 480px)" href="/assets/themes/twitter-ext/css/iphone.css" type="text/css" rel="stylesheet" />
    <!--<link media="only screen and (device-width: 768px)" href="/assets/themes/twitter-ext/css/ipad.css" type="text/css" rel="stylesheet" />-->
    <!--<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />-->
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico" />
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png" />-->
<!--<script type="text/x-mathjax-config">-->
  <!--MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });-->
<!--</script>-->
<!--<script type="text/javascript"-->
  <!--src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">-->
<!--</script>-->
  </head>
  <body>
    <div id="fb-root"></div>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="avatar" href="/">
            <img src="http://gravatar.com/avatar/97aa01a6f87da85251be77792dec1d9c?s=80" height="75" width="75" class="avatar" />
          </a>
          <a class="brand" href="/">hp12c</a>
          <div id='rss'>
            <!--<a href="http://feeds.feedburner.com/github/melborne" title="Subscribe to my feed" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon32x32.png" alt="" style="border:0"/></a><a href="http://feeds.feedburner.com/github/melborne" title="Subscribe to my feed" rel="alternate" type="application/rss+xml"></a>-->
            <a href="/atom.xml" id="rss">
              <img src="/assets/images/site/rss.png" alt="rss" title="RSS" height="22" width="22" />
            </a>
          </div>
          <ul class="nav">
            <li>
              <a class="books" href="/books/">Books</a>
            </li>
            <li>
              <a class="mygems" href="https://rubygems.org/profiles/melborne/">Gems</a>
            </li>
            <li>
              <a class="myproducts" href="http://welove.herokuapp.com/users/54">Products</a>
            </li>
            
            
            


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  

  
    
  

  
    
    	
      <li><a href="/tags.html">Tags</a></li>
    	
    
  








            <li class='site'>
              <a href="https://twitter.com/merborne" id="twitter">
                <img src="/assets/images/site/twitter.png" alt="twitter" title="@merborne on Twitter" height="32" width="32" />
              </a>
            </li>
            <li class='site'>
              <a href="https://github.com/melborne" id="github">
                <img src="/assets/images/site/github.png" alt="github" title="@melborne on GitHub" height="24" width="24" />
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        
<div class="page-header span8">
  <div class="date"><span>27 May 2010</span></div>
  <h1 class='page-title'><a href="/2010/05/27/Ruby-_why-bloopsaphone">Rubyでマリオを奏でよう！</a> <small> _whyのbloopsaphoneの紹介 </small></h1>
</div>

<div class="row">
  <div class="span9">
    <div class="ad" id="topAdsense">
      <script type="text/javascript"><!--
      google_ad_client = "ca-pub-8790567277062819";
      /* hp12c */
      google_ad_slot = "7055414638";
      google_ad_width = 728;
      google_ad_height = 90;
      //-->
      </script>
      <script type="text/javascript"
      src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script>
    </div>

    <p>2009年8月19日Ruby界の鬼才<em>why<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup>が
ネットから忽然と姿を消しました<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup>
この突然の出来事にRubyist達は驚きそして困惑しました
なぜなら彼自身がただネットから消えたのではなく
</em>whyはネット上の彼の痕跡も同時にすべて消し去ったのです！</p>

<p>Rubyのガイドブック　ブログ　音楽　カートゥーン
そしてアクティブなライブラリを含む多数のプログラムコード
camping hpricot redcloth shoes TryRuby metaid...
<em>whyは削除コマンドを実行して
</em>whyの作品群をクラウドのメモリーから削除しました</p>

<p>このような行動に対しネット上には賛否両論がありましたが
多くの人はそこに至った_whyの心情を悲しみました</p>

<p>そう<em>whyは</em>whyの手によって抹殺されたのです...</p>

<p>しかし</p>

<p><em>whyにも削除できない記憶域がありました
それはクラウドの向こう側にいる人々の脳内記憶でした
</em>whyというユニークなペルソナを
人々の記憶から消し去ることは彼にもできなかったのです</p>

<p>その結果としてコミュニティにより
_whyの作品群はネット上に再生されました</p>

<p><a href="http://viewsourcecode.org/why/">_why's Estate</a></p>

<p>ポストモダン時代の天才として
_whyの軌跡を追う記事が最近書かれました</p>

<p><a href="http://www.smashingmagazine.com/2010/05/15/why-a-tale-of-a-post-modern-genius/">Why: A Tale Of A Post-Modern Genius</a></p>

<p>改めて_whyのユニークさを実感します</p>

<p>そう_whyは今も生きているのです...</p>

<h2>bloopsaphone</h2>

<p>先の記事で_whyのbloopsaphoneというライブラリを知りました
以下ではその使い方を簡単に説明したいと思います</p>

<p>bloopsaphoneはファミコンサウンドのような
電子音を作るためのRubyとCのライブラリです</p>

<p><a href="http://github.com/mental/bloopsaphone">mental's bloopsaphone at master - GitHub</a></p>

<p>まずはbloopsaphoneで作った音を聞いてください</p>

<p><a href="http://dl.dropbox.com/u/58702/sample.mp3:sound">link</a></p>

<p>これはライブラリに付属の次のコードを再生したものです</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">test</span><span class="o">.</span><span class="n">rb</span>
<span class="nb">require</span> <span class="s1">&#39;bloops&#39;</span>
<span class="c1"># the song object</span>
<span class="n">b</span> <span class="o">=</span> <span class="no">Bloops</span><span class="o">.</span><span class="n">new</span>
<span class="n">b</span><span class="o">.</span><span class="n">tempo</span> <span class="o">=</span> <span class="mi">320</span>
<span class="c1"># an instrument</span>
<span class="n">saw</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">sound</span> <span class="ss">Bloops</span><span class="p">:</span><span class="ss">:SINE</span>
<span class="c1">#saw = b.sound Bloops::SAWTOOTH</span>
<span class="c1"># assign a track to the song</span>
<span class="n">b</span><span class="o">.</span><span class="n">tune</span> <span class="n">saw</span><span class="p">,</span> <span class="s2">&quot;c5 c6 b4 b5 d5 d6 e5 e6b&quot;</span>
<span class="c1"># make it go</span>
<span class="n">b</span><span class="o">.</span><span class="n">play</span>
<span class="nb">sleep</span> <span class="mi">1</span> <span class="k">while</span> <span class="o">!</span><span class="n">b</span><span class="o">.</span><span class="n">stopped?</span>
<span class="c1"># a percussion</span>
<span class="n">beat</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">sound</span> <span class="ss">Bloops</span><span class="p">:</span><span class="ss">:NOISE</span>
<span class="n">beat</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">6</span>
<span class="c1"># assign a track to the song</span>
<span class="n">b</span><span class="o">.</span><span class="n">tune</span> <span class="n">beat</span><span class="p">,</span> <span class="s2">&quot;4 4 b4 4 d5 4 e5 e6&quot;</span>
<span class="c1"># make it go</span>
<span class="n">b</span><span class="o">.</span><span class="n">play</span>
<span class="nb">sleep</span> <span class="mi">1</span> <span class="k">while</span> <span class="o">!</span><span class="n">b</span><span class="o">.</span><span class="n">stopped?</span>
</code></pre></div>


<p>ライブラリにはドキュメントがないですが
サンプルコードを見れば大体使い方がわかります</p>

<p>手順としては次のようになります</p>

<ol>
<li>Bloops.newでsongオブジェクトを作り(Bloopsクラスのインスタンス生成)</li>
<li>tempoメソッドでテンポを決め</li>
<li>soundメソッドで楽器(音)を選び(Soundクラスのインスタンス生成)</li>
<li>setterメソッドで音質調整をし</li>
<li>tuneメソッドで楽譜をセットして(Trackクラスのインスタンス生成)</li>
<li>playメソッドで再生する</li>
</ol>


<p>複数トラックの再生が可能で
この例では１回目は１トラック
２回目は２トラックで再生しています</p>

<p>楽器(sound)にはSQUARE SAWTOOTH SINE NOISEの４種があって
そのベース音に対して音質調整用メソッド(ここではrepeat)で
音質調整して最終的な音質を決めます</p>

<p>楽譜はRTTTL(Ring Tone Transfer Language)<sup id='fnref:3'><a href='#fn:3' rel='footnote'>3</a></sup>を
ベースにした記法の文字列を渡します
音符の音価(長さ)と音高と音程(オクターブ)を
数字・アルファベット・数字の組で表します
例えば"8:F#4"は"８分音符F#(ファ#)オクターブ４"を表します
音価と音程は省略可能でありその場合はデフォルト値が使われます
オクターブは"+"または"-"で表すこともできます
また":"は省略可能です
休符は数字のみで表されて例えば"4"は"４分休符"を表します</p>

<p>(READMEにある)シンプソンのテーマは次のようになります</p>

<div class="highlight"><pre><code class="bash">32 + C E F# 8:A G E C - 8:A 8:F# 8:F# 8:F# 2:G
</code></pre></div>


<p>これは以下を表しています</p>

<div class="highlight"><pre><code class="bash">32分休符 １オクターブ上げ 4分C 4分E 4分F# 8分A 4分G 4分E 4分C
１オクターブ下げ 8分A 8分F# 8分F# 8分F# 2分G
</code></pre></div>


<h2>インストール</h2>

<p>OSXへのインストールは以下のようにします<sup id='fnref:4'><a href='#fn:4' rel='footnote'>4</a></sup></p>

<div class="highlight"><pre><code class="bash">sudo port install portaudio
sudo gem install bloopsaphone -- --with-opt-lib<span class="o">=</span>/opt/local/lib --with-opt-include<span class="o">=</span>/opt/local/include
</code></pre></div>


<p>bloopsaphoneはportaudioというオーディオI/Oライブラリに依存しています</p>

<h2>音質調整メソッド</h2>

<p>音質調整はBloops#soundメソッドで生成されるSoundクラスの
インスタンスメソッドで行います
それぞれ0.0～1.0の値をセットします</p>

<div class="highlight"><pre><code class="ruby"><span class="n">lead</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">sound</span> <span class="ss">Bloops</span><span class="p">:</span><span class="ss">:SQUARE</span>
<span class="n">lead</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
<span class="n">lead</span><span class="o">.</span><span class="n">attack</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mo">02</span>
<span class="n">lead</span><span class="o">.</span><span class="n">sustain</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">4</span>
<span class="n">lead</span><span class="o">.</span><span class="n">decay</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">7</span>
<span class="n">lead</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
<span class="n">lead</span><span class="o">.</span><span class="n">psweep</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
<span class="n">lead</span><span class="o">.</span><span class="n">vibe</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
<span class="n">lead</span><span class="o">.</span><span class="n">vspeed</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
</code></pre></div>


<p>各メソッドの機能は名前から推測できるものもありますが
そうでないものもあります
値を調整して試してみるほかないようです</p>

<p>音質調整は設定ファイルをロードして行うこともできます</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;bloops&#39;</span>
<span class="n">bases</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;../../sounds/*.blu&quot;</span><span class="o">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="no">Bloops</span><span class="o">.</span><span class="n">new</span>
<span class="n">bases</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">base</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;** playing scale using </span><span class="si">#{</span><span class="n">base</span><span class="o">[</span><span class="sr">/\w+.blu/</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="n">sound</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">load</span> <span class="n">base</span>
  <span class="n">b</span><span class="o">.</span><span class="n">tune</span> <span class="n">sound</span><span class="p">,</span> <span class="s2">&quot;c c# d eb e f f# g ab a bb b + c&quot;</span>
  <span class="n">b</span><span class="o">.</span><span class="n">play</span>
  <span class="nb">sleep</span> <span class="mi">1</span> <span class="k">while</span> <span class="o">!</span><span class="n">b</span><span class="o">.</span><span class="n">stopped?</span>
  <span class="n">b</span><span class="o">.</span><span class="n">clear</span>
<span class="k">end</span>
</code></pre></div>


<p>このコードはライブラリに添付の複数の設定ファイルを読み出し
各音質で同じコードを再生するものです
音質調整で様々な音が再現できることが分かると思います</p>

<p><a href="http://dl.dropbox.com/u/58702/sample2.mp3:sound">link</a></p>

<p>ここで再生した各設定ファイルは以下の通りです</p>

<div class="highlight"><pre><code class="bash">dart.blu
<span class="nb">type    </span>noise
punch   0.524
sustain 0.160
decay   0.367
freq    0.296
slide  -0.373
vibe    0.665
vspeed  0.103
phase   0.141
psweep -0.005
</code></pre></div>




<div class="highlight"><pre><code class="bash">error.blu
<span class="nb">type      </span>square
sustain   0.333
decay     0.380
freq      0.336
slide     0.292
square    0.289
sweep     0.020
vibe      0.002
lpf       0.220
lsweep    0.015
resonance 0.875
aspeed    0.035
repeat    0.551
</code></pre></div>




<div class="highlight"><pre><code class="bash">ice.blu
<span class="nb">type    </span>square
punch   0.441
sustain 0.067
decay   0.197
freq    0.499
</code></pre></div>




<div class="highlight"><pre><code class="bash">jump.blu
<span class="nb">type    </span>square
sustain 0.266
decay   0.187
freq    0.268
slide   0.179
square  0.326
vibe    0.227
vspeed  0.231
</code></pre></div>




<div class="highlight"><pre><code class="bash">pogo.blu
<span class="nb">type      </span>square
volume    0.977
punch     0.190
sustain   0.165
slide     0.100
dslide    0.030
square    0.048
sweep    -0.055
vibe      0.437
vspeed    0.310
lpf       0.355
resonance 0.185
hpf       0.205
hsweep    0.255
arp       0.677
aspeed    0.275
phase     0.200
psweep   -0.565
repeat    0.500
</code></pre></div>




<div class="highlight"><pre><code class="bash">stun.blu
<span class="nb">type    </span>sawtooth
sustain 0.306
decay   0.477
freq    0.429
slide   0.217
repeat  0.677
</code></pre></div>


<h2>メソッド一覧</h2>

<p>bloopsaphoneのメソッド群は次のようになります</p>

<div class="highlight"><pre><code class="bash">Bloopsクラス
 instance methods: clear, load, play, sound, stopped?, tempo, <span class="nv">tempo</span><span class="o">=</span>, tune
 constants: SQUARE, SAWTOOTH, SINE, NOISE
Soundクラス
 instance methods: arp, <span class="nv">arp</span><span class="o">=</span>, aspeed, <span class="nv">aspeed</span><span class="o">=</span>, attack, <span class="nv">attack</span><span class="o">=</span>, decay, <span class="nv">decay</span><span class="o">=</span>, dslide, <span class="nv">dslide</span><span class="o">=</span>, freq, <span class="nv">freq</span><span class="o">=</span>, hpf, <span class="nv">hpf</span><span class="o">=</span>, hsweep, <span class="nv">hsweep</span><span class="o">=</span>, limit, <span class="nv">limit</span><span class="o">=</span>, lpf, <span class="nv">lpf</span><span class="o">=</span>, lsweep, <span class="nv">lsweep</span><span class="o">=</span>, phase, <span class="nv">phase</span><span class="o">=</span>, psweep, <span class="nv">psweep</span><span class="o">=</span>, punch, <span class="nv">punch</span><span class="o">=</span>, repeat, <span class="nv">repeat</span><span class="o">=</span>, resonance, <span class="nv">resonance</span><span class="o">=</span>, slide, <span class="nv">slide</span><span class="o">=</span>, square, <span class="nv">square</span><span class="o">=</span>, sweep, <span class="nv">sweep</span><span class="o">=</span>, sustain, <span class="nv">sustain</span><span class="o">=</span>, <span class="nb">type</span>, <span class="nb">type</span><span class="o">=</span>, vibe, <span class="nv">vibe</span><span class="o">=</span>, vspeed, <span class="nv">vspeed</span><span class="o">=</span>, vdelay, <span class="nv">vdelay</span><span class="o">=</span>, volume, <span class="nv">volume</span><span class="o">=</span>
Trackクラス
 instance methods: to_s
</code></pre></div>


<h2>BloopSong DSL</h2>

<p>bloopsaphoneで長い楽譜を再生しようとすると</p>

<p>以下のような問題がありました
1. CPUの占有率が徐々に上がって途中で再生不能になる
1. トラック数が増えるとコードの可読性が下がる
1. トラック数を変えたり楽譜の一部の小節だけを再生をするのに手間が掛かる</p>

<p>そこでこれらの問題に対応するために
BloopSongという簡単なＤＳＬを書きました</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s2">&quot;bloops&quot;</span>
<span class="k">class</span> <span class="nc">BloopSong</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="n">tempo</span><span class="p">)</span>
    <span class="vi">@bloops</span> <span class="o">=</span> <span class="no">Bloops</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@bloops</span><span class="o">.</span><span class="n">tempo</span> <span class="o">=</span> <span class="n">tempo</span>
    <span class="k">yield</span> <span class="nb">self</span>
    <span class="nb">self</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">play</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">read_score</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="n">tunes</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="n">opt</span><span class="o">[</span><span class="ss">:tune</span><span class="o">]</span> <span class="o">||</span> <span class="ss">:lead</span><span class="p">)</span>
    <span class="n">range_max</span> <span class="o">=</span> <span class="n">score</span><span class="o">[</span><span class="n">tunes</span><span class="o">.</span><span class="n">first</span><span class="o">].</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">range</span><span class="p">(</span><span class="n">opt</span><span class="o">[</span><span class="ss">:range</span><span class="o">]</span><span class="p">,</span> <span class="n">range_max</span><span class="p">)</span>
      <span class="n">tunes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">tune</span><span class="o">|</span>
        <span class="vi">@bloops</span><span class="o">.</span><span class="n">tune</span> <span class="nb">send</span><span class="p">(</span><span class="n">tune</span><span class="p">),</span> <span class="n">score</span><span class="o">[</span><span class="n">tune</span><span class="o">][</span><span class="n">i</span><span class="o">]</span>
      <span class="k">end</span>
      <span class="vi">@bloops</span><span class="o">.</span><span class="n">play</span>
      <span class="nb">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mo">01</span> <span class="k">until</span> <span class="vi">@bloops</span><span class="o">.</span><span class="n">stopped?</span>
      <span class="vi">@bloops</span><span class="o">.</span><span class="n">clear</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">define_class_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="p">(</span><span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span><span class="p">;</span> <span class="nb">self</span> <span class="k">end</span><span class="p">)</span><span class="o">.</span><span class="n">module_eval</span> <span class="p">{</span> <span class="n">define_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="p">{</span> <span class="k">yield</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">sound</span><span class="p">(</span><span class="nb">name</span><span class="o">=</span><span class="ss">:lead</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="vi">@bloops</span><span class="o">.</span><span class="n">sound</span><span class="p">(</span> <span class="no">Bloops</span><span class="o">.</span><span class="n">module_eval</span><span class="p">(</span><span class="n">type</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span> <span class="p">))</span>
    <span class="n">define_class_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">instance_variable_get</span><span class="p">(</span><span class="s2">&quot;@</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">yield</span> <span class="nb">send</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="k">if</span> <span class="nb">block_given?</span>
    <span class="vi">@bloops</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">read_score</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="ss">:lead</span>
    <span class="n">score</span><span class="o">.</span><span class="n">each_line</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
      <span class="k">next</span> <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/^\s*$/</span>
      <span class="k">case</span> <span class="n">line</span>
      <span class="k">when</span> <span class="sr">/^:(\w+)/</span> <span class="k">then</span> <span class="n">flag</span> <span class="o">=</span> <span class="vg">$1</span>
      <span class="k">else</span>
        <span class="n">q</span><span class="o">[</span><span class="n">flag</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span> <span class="o">+=</span> <span class="o">[</span><span class="n">line</span><span class="o">]</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">q</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">range</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">max</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">opt</span>
      <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="n">.max</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="n">opt</span><span class="o">.</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">max</span> <span class="o">||</span> <span class="n">opt</span><span class="o">.</span><span class="n">end</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="p">(</span><span class="n">opt</span><span class="o">.</span><span class="n">begin</span><span class="o">.</span><span class="n">.max</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">opt</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>


<p>以下のように使います</p>

<div class="highlight"><pre><code class="ruby"><span class="n">require_relative</span> <span class="s2">&quot;bloopsong&quot;</span>
<span class="n">mario</span> <span class="o">=</span>
  <span class="no">BloopSong</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="mi">216</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">b</span><span class="o">|</span>
    <span class="n">b</span><span class="o">.</span><span class="n">sound</span><span class="p">(</span><span class="ss">:lead</span><span class="p">,</span> <span class="ss">:SQUARE</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
      <span class="n">s</span><span class="o">.</span><span class="n">volume</span>  <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">4</span>
      <span class="n">s</span><span class="o">.</span><span class="n">punch</span>   <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">441</span>
      <span class="n">s</span><span class="o">.</span><span class="n">sustain</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mo">067</span>
      <span class="n">s</span><span class="o">.</span><span class="n">decay</span>   <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">297</span>
      <span class="n">s</span><span class="o">.</span><span class="n">freq</span>    <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">499</span>
    <span class="k">end</span>
  
    <span class="n">b</span><span class="o">.</span><span class="n">sound</span><span class="p">(</span><span class="ss">:lead2</span><span class="p">,</span> <span class="ss">:SQUARE</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
      <span class="n">s</span><span class="o">.</span><span class="n">volume</span>  <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">4</span>
      <span class="n">s</span><span class="o">.</span><span class="n">punch</span>   <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">441</span>
      <span class="n">s</span><span class="o">.</span><span class="n">sustain</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mo">067</span>
      <span class="n">s</span><span class="o">.</span><span class="n">decay</span>   <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">297</span>
      <span class="n">s</span><span class="o">.</span><span class="n">freq</span>    <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">499</span>
    <span class="k">end</span>
    <span class="n">b</span><span class="o">.</span><span class="n">sound</span><span class="p">(</span><span class="ss">:base</span><span class="p">,</span> <span class="ss">:SQUARE</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span>
      <span class="n">s</span><span class="o">.</span><span class="n">volume</span>  <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">4</span>
      <span class="n">s</span><span class="o">.</span><span class="n">punch</span>   <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">641</span>
      <span class="n">s</span><span class="o">.</span><span class="n">sustain</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">197</span>
      <span class="n">s</span><span class="o">.</span><span class="n">decay</span>   <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">197</span>
      <span class="n">s</span><span class="o">.</span><span class="n">freq</span>    <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">499</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="n">mario</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="no">DATA</span><span class="p">,</span> <span class="ss">:range</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="ss">:tune</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:lead</span><span class="p">,</span> <span class="ss">:lead2</span><span class="p">,</span> <span class="ss">:base</span><span class="o">]</span><span class="p">)</span>
<span class="cp">__END__</span>
<span class="cp">:lead</span>
<span class="cp"> 8E5 8E5 8 8E5 8 8C5 4E5    4G5 4 4G4 4           4C5 8 8G4 4 4E4          8 4A4 4B4 8A#4 4A4</span>
<span class="cp"> 6G4 6E5 6G5 4A5 8F5 8G5    8 4E5 8C5 8D5 4B4 8   4C5 8 8G4 4 4E4          8 4A4 4B4 8A#4 4A4</span>
<span class="cp"> 6G4 6E5 6G5 4A5 8F5 8G5    8 4E5 8C5 8D5 4B4 8   4 8G5 8F#5 8F5 4D#5 8E5  8 8G#4 8A4 8C5 8 8A4 8C5 8D5</span>
<span class="cp"> 4 8G5 8F#5 8F5 4D#5 8E5    8 4C6 8C6 4C6 4       4 8G5 8F#5 8F5 4D#5 8E5  8 8G#4 8A4 8C5 8 8A4 8C5 8D5</span>
<span class="cp">:lead2</span>
<span class="cp"> 8F#4 8F#4 8 8F#4 8 8F#4 4F#4   4G4 4 4G4 4          4E4 8 8E4 4 4C4         8 4C4 4D4 8C#4 4C4</span>
<span class="cp"> 6C4 6E4 6B4 4C5 8A4 8B4        8 4A4 8E4 8F4 4D4 8  4E4 8 8E4 4 4C4         8 4C4 4D4 8C#4 4C4</span>
<span class="cp"> 6C4 6E4 6B4 4C5 8A4 8B4        8 4A4 8E4 8F4 4D4 8  4 8E5 8D#5 8D5 4B4 8C5  8 8E4 8F4 8A4 8 8C4 8E4 8F4</span>
<span class="cp"> 4 8E5 8D#5 8D5 4B4 8C5         8 4G5 8G5 4G5 4      4 8E5 8D#5 8D5 4B4 8C5  8 8E4 8F4 8A4 8 8C4 8E4 8F4</span>
<span class="cp">:base</span>
<span class="cp"> 8D3 8D3 8 8D3 8 8D3 4D3   4G3 4 4G3 4           4G3 8 8E3 4 4C3         8 4F3 4G3 8F#3 4E3</span>
<span class="cp"> 6E3 6C4 6E4 4F4 8D4 8E4   8 4C4 8A3 8B3 4G3 8   4G3 8 8E3 4 4C3         8 4F3 4G3 8F#3 4E3</span>
<span class="cp"> 6E3 6C4 6E4 4F4 8D4 8E4   8 4C4 8A3 8B3 4G3 8   4C3 8 8G3 4 4C4         4F3 8 8C4 4C4 4F3</span>
<span class="cp"> 4C3 8 8E3 4 8G3 8C4       2 4 4G3               4C3 8 8G3 4 4C4         4F3 8 8C4 4C4 4F3 </span>
</code></pre></div>


<p>BloopSong.initの引数にテンポを渡し
そのブロック内で各楽器の設定を行います
楽器を指定するsoundメソッドの引数には
楽器名とその種類をシンボルで渡し
そのブロック内で音質調整を行います</p>

<p>楽譜はplayメソッドの第1引数に文字列として渡します
渡す文字列においてパート名はシンボル表記します
省略すると:leadが自動的にセットされます</p>

<p>BloopSong.playメソッドは
 :rangeと:tuneの２つキーワード引数を取ります
rangeは楽譜の再生行(小節ではない)を指定します
例のようにするか省略した時にはすべてを再生します
tuneで指定したパートのみを再生します</p>

<p><a href="http://dl.dropbox.com/u/58702/mario_theme.mp3:sound">link</a></p>

<p>コードは以下のリンクにあります</p>

<p><a href="http://github.com/melborne/bloopsong">melborne's bloopsong at master - GitHub</a></p>

<p>(追記：2010-12-4)bloopsongの修正に伴い、コードおよび一部記述を修正しました。</p>

<p>[関連サイト]
<a href="http://www.urbanhonking.com/ideasfordozens/2009/05/early_8bit_sounds_from__whys_b.html">Early 8-bit Sounds from _why's Bloopsaphone</a>
<a href="http://www.aanandprasad.com/1901">A chiptune cover of Phoenix’s “1901”</a>
<a href="http://adminmyserver.com/articles/ruby-pong-with-shoes-and-bloopsaphone">AdminMyServer - ruby pong with shoes and bloopsaphone</a></p>

<div class="footnotes">
    <ol>
        <li id='fn:1'>http://en.wikipedia.org/wiki/Why_the_lucky_stiff:title <a href='#fnref:1' rev='footnote'>↩</a></li><li id='fn:2'>http://www.rubyinside.com/why-the-lucky-stiff-is-missing-2278.html:title <a href='#fnref:2' rev='footnote'>↩</a></li><li id='fn:3'>http://en.wikipedia.org/wiki/Ring_Tone_Transfer_Language:title <a href='#fnref:3' rev='footnote'>↩</a></li><li id='fn:4'>Installing _why's Bloopsaphone on OS X http://deaddeadgood.com/2010/2/13/installing-_why-s-bloopsaphone-on-os-x/ <a href='#fnref:4' rev='footnote'>↩</a></li>
    </ol>
</div>





    <div class="ad" id="topAdsense">
      <script type="text/javascript"><!--
      google_ad_client = "ca-pub-8790567277062819";
      /* foot */
      google_ad_slot = "7511276945";
      google_ad_width = 728;
      google_ad_height = 90;
      //-->
      </script>
      <script type="text/javascript"
      src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script>
    </div>

    <hr>
    <ul class="social_button inline">
      <li id="hatena">
  <a href="http://b.hatena.ne.jp/entry/http://melborne.github.io/2010/05/27/Ruby-_why-bloopsaphone/" class="hatena-bookmark-button" data-hatena-bookmark-title="Rubyでマリオを奏でよう！" data-hatena-bookmark-layout="horizontal" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" width="20" height="30" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
</li>

<li id="twitter">
  <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://melborne.github.io/2010/05/27/Ruby-_why-bloopsaphone/" data-text="Rubyでマリオを奏でよう！" data-via="merborne" data-lang="ja" data-size="" data-count="horizontal"></a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</li>

<li id="google">
  <link rel="canonical" href="http://melborne.github.io/2010/05/27/Ruby-_why-bloopsaphone/" />
  <g:plusone size="medium"></g:plusone>
  
  <script type="text/javascript">
    window.___gcfg = {lang: 'ja'};
  
    (function() {
      var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
      po.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
  </script>
</li>

<li id="facebook">
  <div class="fb-like" data-href="http://melborne.github.io/2010/05/27/Ruby-_why-bloopsaphone/" data-layout="button_count" data-send="false" data-width="150" data-show-faces="false"></div>
</li>

<li></li>




    </ul>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2010/03/24/Yet-Another-Ruby-FizzBuzz-4" title="Yet Another Ruby FizzBuzz その4">&larr; Previous</a></li>
      
        <li><a href="/">Archive</a></li>
        <!--<li><a href="/archive.html">Archive</a></li>-->
      
        <li class="next"><a href="/2010/06/10/Termtter" title="Termtterなら友だちだって見つけられる！">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'melborne'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  <div class="span3">
    <div id="bookAd">
      <a href="/books/">
        <!--<img src="/assets/images/2012/start_ruby.jpg" alt="start_ruby" />-->
        <!--<img src="/assets/images/2012/jekyll_cover.jpg" alt="jekyll" />-->
        <!--<img src="/assets/images/2012/ruby_parallel_cover.png" alt="ruby_parallel" />-->
        <!--<img src="/assets/images/2012/js_oop_cover.png" alt="js_oop" />-->
        <!--<img src="/assets/images/2012/rack_cover.png" alt="rack" />-->
        <!--<img src="/assets/images/2013/02/ruby_object_cover.png" alt="ruby_object" />-->
        <!--<img src="/assets/images/2013/03/ruby_trivia_cover.png" alt="ruby_trivia" />-->
        <img src="/assets/images/books/ruby_pack8.png" alt="ruby_pack8" style="width:200px" />
      </a>
      <p id="comment">100円〜で好評発売中！<br/><a href="/books/">M'ELBORNE BOOKS</a></p>
    </div>

    <hr />
    

    <ul class="social_button inline">
      <li id="hatena">
  <a href="http://b.hatena.ne.jp/entry/http://melborne.github.io/2010/05/27/Ruby-_why-bloopsaphone/" class="hatena-bookmark-button" data-hatena-bookmark-title="Rubyでマリオを奏でよう！" data-hatena-bookmark-layout="horizontal" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" width="20" height="30" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
</li>

<li id="twitter">
  <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://melborne.github.io/2010/05/27/Ruby-_why-bloopsaphone/" data-text="Rubyでマリオを奏でよう！" data-via="merborne" data-lang="ja" data-size="" data-count="horizontal"></a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</li>

<li id="google">
  <link rel="canonical" href="http://melborne.github.io/2010/05/27/Ruby-_why-bloopsaphone/" />
  <g:plusone size="medium"></g:plusone>
  
  <script type="text/javascript">
    window.___gcfg = {lang: 'ja'};
  
    (function() {
      var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
      po.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
  </script>
</li>

<li id="facebook">
  <div class="fb-like" data-href="http://melborne.github.io/2010/05/27/Ruby-_why-bloopsaphone/" data-layout="button_count" data-send="false" data-width="150" data-show-faces="false"></div>
</li>

<li></li>




    </ul>

    <div class="ad" id="sideAdsense">
      <script type="text/javascript"><!--
      google_ad_client = "ca-pub-8790567277062819";
      /* sidebar */
      google_ad_slot = "0672114662";
      google_ad_width = 160;
      google_ad_height = 600;
      //-->
      </script>
      <script type="text/javascript"
      src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script>
    </div>
  </div>
</div>


      </div>

      <footer>
        <p><a rel="license" href="http://creativecommons.org/licenses/by-nc/2.1/jp/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc/2.1/jp/88x31.png" /></a>  kyoendo 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>        </p>
      </footer>

    </div> <!-- /container -->

    

    <script type="text/javascript">
      if (location.hostname != 'localhost') {
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-288751-18']);
        _gaq.push(['_trackPageview']);
  
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      };
    </script>

    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>

    <script src="/assets/javascripts/jquery-1.7.2.min.js"></script>
    <script src="/assets/javascripts/lightbox.js"></script>

    <script type="text/javascript" src="https://gumroad.com/js/gumroad.js"></script>
  </body>
</html>

