
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    
      <title>Graphvizで作る、私たちの国「日本」の今度こそ本当の姿かたち</title>
    
    <meta name="description" content="" />
    <meta name="author" content="kyoendo" />

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter-ext/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="/assets/themes/twitter-ext/css/style.css?body=1" rel="stylesheet" type="text/css" media="all" />
    <link href="/assets/themes/twitter-ext/css/syntax.css" rel="stylesheet" type="text/css" />
    <link href="/assets/themes/twitter-ext/css/lightbox.css" rel="stylesheet" />
    <link media="only screen and (max-device-width: 480px)" href="/assets/themes/twitter-ext/css/iphone.css" type="text/css" rel="stylesheet" />
    <!--<link media="only screen and (device-width: 768px)" href="/assets/themes/twitter-ext/css/ipad.css" type="text/css" rel="stylesheet" />-->
    <!--<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />-->
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico" />
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png" />-->
<!--<script type="text/x-mathjax-config">-->
  <!--MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ["\\(","\\)"]] } });-->
<!--</script>-->
<!--<script type="text/javascript"-->
  <!--src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML">-->
<!--</script>-->
  </head>
  <body>
    <div id="fb-root"></div>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="avatar" href="/">
            <img src="http://gravatar.com/avatar/97aa01a6f87da85251be77792dec1d9c?s=80" height="75" width="75" class="avatar" />
          </a>
          <a class="brand" href="/">hp12c</a>
          <div id='rss'>
            <a href="http://feeds.feedburner.com/github/melborne" title="Subscribe to my feed" rel="alternate" type="application/rss+xml"><img src="http://www.feedburner.com/fb/images/pub/feed-icon32x32.png" alt="" style="border:0"/></a><a href="http://feeds.feedburner.com/github/melborne" title="Subscribe to my feed" rel="alternate" type="application/rss+xml"></a>
            <!--<a href="/atom.xml" id="rss">-->
              <!--<img src="/assets/images/site/rss.png" alt="rss" title="RSS" height="22" width="22" />-->
            <!--</a>-->
          </div>
          <ul class="nav">
            <li>
              <a class="books" href="/books/">Books</a>
            </li>
            <li>
              <a class="mygems" href="https://rubygems.org/profiles/melborne/">Gems</a>
            </li>
            <li>
              <a class="myproducts" href="http://welove.herokuapp.com/users/54">Products</a>
            </li>
            
            
            


  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  
    
  

  

  

  
    
  

  
    
    	
      <li><a href="/tags.html">Tags</a></li>
    	
    
  








            <li class='site'>
              <a href="https://twitter.com/merborne" id="twitter">
                <img src="/assets/images/site/twitter.png" alt="twitter" title="@merborne on Twitter" height="32" width="32" />
              </a>
            </li>
            <li class='site'>
              <a href="https://github.com/melborne" id="github">
                <img src="/assets/images/site/github.png" alt="github" title="@melborne on GitHub" height="24" width="24" />
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        
<div class="page-header span8">
  <div class="date"><span>25 March 2013</span></div>
  <h1 class='page-title'><a href="/2013/03/25/map-of-japan-2">Graphvizで作る、私たちの国「日本」の今度こそ本当の姿かたち</a> <small>  </small></h1>
</div>

<div class="row">
  <div class="span9">
    <div class="ad" id="topAdsense">
      <script type="text/javascript"><!--
      google_ad_client = "ca-pub-8790567277062819";
      /* hp12c */
      google_ad_slot = "7055414638";
      google_ad_width = 728;
      google_ad_height = 90;
      //-->
      </script>
      <script type="text/javascript"
      src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script>
    </div>

    <p>僕は前回、<a href="http://d.hatena.ne.jp/antlabo/">antlabo</a>さんが公開されている<a href="http://d.hatena.ne.jp/antlabo/20121029/1351520444">全国市区町村の隣接データ</a>に基いて、Graphvizで次のような日本を作りました。</p>

<p><a href="/assets/images/2013/03/jpmap_svg.html" title="Metro Map"><img src="/assets/images/2013/03/jpmap_color.png" alt="japan noshadow" /></a></p>

<blockquote><p><a href="http://melborne.github.com/2013/03/22/map-of-japan/" target="_blank">"Graphvizで作る、私たちの国「日本」の本当の姿かたち" </a><a href="http://b.hatena.ne.jp/entry/http://melborne.github.com/2013/03/22/map-of-japan/" class="http-bookmark" target="_blank"><img src="http://b.hatena.ne.jp/entry/image/http://melborne.github.com/2013/03/22/map-of-japan/" alt="error" class="http-bookmark"></a></p></blockquote>

<p>ええ、これが「日本」です。</p>

<p>まあ、これはこれで面白かったのですが、全体的形状としては現実の日本国土とは程遠いものとなりました。都道府県の隣接情報に基いて日本を書いたときや、州の隣接情報に基いて米国を書いたときには、それなりに上手くいっていたのですが、今回のようにノード数が異常に多いとGraphvizにおける配置演算が難しくなって、隣接ノード間の距離がまちまちになってしまうのです。</p>

<p>それで、各市町村の位置情報があればうまくいくはずということで、どこかにそのようなデータがないか探してみたところ、<a href="http://nlftp.mlit.go.jp/isj/" title="位置参照情報ダウンロードサービス">位置参照情報ダウンロードサービス</a>という国土交通省のサイトを見つけ、早々ダウンロードして使ってみました。しかし、位置情報が街区単位（何丁目何番地）と細かく、データの前処理が面倒だなーと思っていたのでした。</p>

<p>そんな折、先のantlaboさんが僕とのツイッターでのやり取りをきっかけに、なんと、全国市町村の役所の位置情報データを公開してくれることになったのです。</p>

<blockquote><p><a href="http://d.hatena.ne.jp/antlabo/20130324/1364107139" title="都道府県市区町村データ公開その3 - 蟻の実験工房（別館ラボ）">都道府県市区町村データ公開その3 - 蟻の実験工房（別館ラボ）</a></p></blockquote>

<p>スバラシイ！</p>

<p>そんなわけで...</p>

<p>今回は、この都道府県市区町村の位置情報に基いて日本地図を描いてみようと思います。ツールはいつものように<a href="https://rubygems.org/gems/gviz" title="gviz | RubyGems.org | your community gem host">gviz</a>を使います。</p>

<p>ノードの位置情報を使ってGraphvizを描くことは既に、「<a href="http://melborne.github.com/2012/10/02/draw-metro-map-with-gviz/" title="東京の地下鉄をGviz（Ruby Graphviz Wrapper）で描く">東京の地下鉄をGviz（Ruby Graphviz Wrapper）で描く</a>」で経験しているので、今回はスムーズにいくと思います。では、ステップ・バイ・ステップで。</p>

<h2>インストール</h2>

<p>Graphvizが必要です。自分のプラットフォームに合ったものを以下から入手して下さい。</p>

<blockquote><p><a href="http://www.graphviz.org/Download..php" title="Download. | Graphviz - Graph Visualization Software">Download. | Graphviz - Graph Visualization Software</a></p></blockquote>

<p>Gvizのインストールは<code>gem install gviz</code>でＯＫです。Rubyは1.9.3以降が必要となります。</p>

<h2>データの前処理</h2>

<p>まずは、先のantlaboさんのサイトから<code>city_location_utf8.csv</code>を取得します。このデータは以下のようなtab separated valueになってます<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup>。</p>

<div class="highlight"><pre><code class="text">id   pref    name    lat lon
673 三重県   いなべ市    35.16079322 136.5017665
796 三重県   亀山市   34.87762199 136.38172496
977 三重県   伊勢市   34.47547466 136.72519867
793 三重県   伊賀市   34.72972645 136.18121136
1040    三重県   南伊勢町    34.30874507 136.58644797
835 三重県   名張市   34.61712737 136.11750322
  ・
  ・
  ・
</code></pre></div>


<p>いつものようにこのデータを直接Gvizに渡してもいいんですが、今回は一手間掛けてCityオブジェクトを作りそれを渡すようにしてみます。<code>city.rb</code>というファイルを作ってCityクラスを作り、このデータに基いてCityオブジェクトを生成します。こんな感じです。</p>

<div class="highlight"><pre><code class="ruby"><span class="c1"># encoding: UTF-8</span>
<span class="k">class</span> <span class="nc">City</span> <span class="o">&lt;</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:pref</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:lat</span><span class="p">,</span> <span class="ss">:lon</span><span class="p">)</span>
  <span class="vc">@@cities</span> <span class="o">=</span> <span class="o">[]</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">cities</span>
      <span class="vc">@@cities</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="vc">@@cities</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">super</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>


<p>@@citiesに生成した全Cityオブジェクトを保持し、City.citiesでアクセスできるようにします。</p>

<p>では、CSVライブラリを使ってデータを読み出し、Cityオブジェクトを生成しましょう。</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s2">&quot;csv&quot;</span>

<span class="n">tsv</span> <span class="o">=</span> <span class="no">CSV</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;city_location_utf8.csv&#39;</span><span class="p">,</span> <span class="n">col_sep</span><span class="ss">:&quot;</span><span class="se">\t</span><span class="ss">&quot;</span><span class="p">)</span>

<span class="n">tsv</span><span class="o">.</span><span class="n">first</span> <span class="c1"># =&gt; #&lt;CSV::Row id:673 pref:&quot;三重県&quot; name:&quot;いなべ市&quot; lat:35.16079322 lon:136.5017665&gt;</span>

<span class="n">tsv</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="no">City</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="p">}</span>

<span class="no">City</span><span class="o">.</span><span class="n">cities</span><span class="o">.</span><span class="n">size</span> <span class="c1"># =&gt; 1747</span>
<span class="no">City</span><span class="o">.</span><span class="n">cities</span><span class="o">.</span><span class="n">first</span> <span class="c1"># =&gt; #&lt;struct City id=673, pref=&quot;三重県&quot;, name=&quot;いなべ市&quot;, lat=35.16079322, lon=136.5017665&gt;</span>
</code></pre></div>


<p>こういうときは、<code>CSV.table</code>が便利です。詳しくは<a href="http://melborne.github.com/2013/01/24/csv-table-method-is-awesome/" title="Ruby標準添付ライブラリcsvのCSV.tableメソッドが最強な件について">こちら</a>を。</p>

<p>Graphvizで絶対位置を指定するときは値を正規化する必要があり、そのために緯度経度のレンジ（最小値-最大値）を使いますので、Cityクラスにこれらの値を保持させましょう。<code>City.lat_range</code>, <code>City.lon_range</code>を定義します。</p>

<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">City</span> <span class="o">&lt;</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:pref</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:lat</span><span class="p">,</span> <span class="ss">:lon</span><span class="p">)</span>
  <span class="vc">@@lat_range</span> <span class="o">=</span> <span class="vc">@@lon_range</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">lat_range</span>
      <span class="vc">@@lat_range</span> <span class="o">||=</span> <span class="no">Range</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="vc">@@cities</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:lat</span><span class="p">)</span><span class="o">.</span><span class="n">minmax</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">lon_range</span>
      <span class="vc">@@lon_range</span> <span class="o">||=</span> <span class="no">Range</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="vc">@@cities</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:lon</span><span class="p">)</span><span class="o">.</span><span class="n">minmax</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">tsv</span> <span class="o">=</span> <span class="no">CSV</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;city_location_utf8.csv&#39;</span><span class="p">,</span> <span class="n">col_sep</span><span class="ss">:&quot;</span><span class="se">\t</span><span class="ss">&quot;</span><span class="p">)</span>
<span class="n">tsv</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="no">City</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="p">}</span>

<span class="no">City</span><span class="o">.</span><span class="n">lat_range</span> <span class="c1"># =&gt; 24.34639481..45.36876935</span>
<span class="no">City</span><span class="o">.</span><span class="n">lon_range</span> <span class="c1"># =&gt; 122.98877472..145.50658293</span>
</code></pre></div>


<p>更に、都道府県別に色を付けたいので、都道府県の色情報をCityクラスに持たせます。色付けには前回同様<code>Colorable</code> gemを使います。</p>

<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s2">&quot;colorable&quot;</span>

<span class="k">class</span> <span class="nc">City</span> <span class="o">&lt;</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:pref</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:lat</span><span class="p">,</span> <span class="ss">:lon</span><span class="p">)</span>
  <span class="vc">@@pref_colors</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
    <span class="k">def</span> <span class="nf">pref_colors</span>
      <span class="vc">@@pref_colors</span> <span class="o">||=</span> <span class="k">begin</span>
        <span class="n">c</span> <span class="o">=</span> <span class="ss">Colorable</span><span class="p">:</span><span class="ss">:Color</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:alice_blue</span><span class="p">)</span>
        <span class="n">prefs</span> <span class="o">=</span> <span class="vc">@@cities</span><span class="o">.</span><span class="n">uniq</span> <span class="p">{</span> <span class="o">|</span><span class="n">city</span><span class="o">|</span> <span class="n">city</span><span class="o">.</span><span class="n">pref</span> <span class="p">}</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:pref</span><span class="p">)</span>
        <span class="no">Hash</span><span class="o">[</span> <span class="n">prefs</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">pr</span><span class="o">|</span> <span class="o">[</span><span class="n">pr</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">next</span><span class="o">]</span> <span class="p">}</span> <span class="o">]</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">City</span><span class="o">.</span><span class="n">pref_colors</span> <span class="c1"># =&gt; {&quot;三重県&quot;=&gt;#&lt;Colorable::Color:0x007fbebb1db038 @name=&quot;Antique White&quot;, @rgb=[250, 235, 215], @hex=nil, @hsb=nil, @esc=nil&gt;, &quot;京都府&quot;=&gt;#&lt;Colorable::Color:0x007fbebb1da458 @name=&quot;Aqua&quot;, @rgb=[0, 255, 255], @hex=nil, @hsb=nil, @esc=nil&gt;, &quot;佐賀県&quot;=&gt;#&lt;Colorable::Color:0x007fbebb1d9440 @name=&quot;Aquamarine&quot;, @rgb=[127, 255, 212], @hex=nil, @hsb=nil, @esc=nil&gt;, &quot;兵庫県&quot;=&gt;#&lt;Colorable::Color:0x007fbebb1d8158 @name=&quot;Azure&quot;, @rgb=[240, 255, 255], @hex=nil, @hsb=nil, @esc=nil&gt;, &quot;北海道&quot;=&gt;#&lt;Colorable::Color:0x007fbebb1e3170 @name=&quot;Beige&quot;, @rgb=[245, 245, 220], @hex=nil, @hsb=nil, @esc=nil&gt;, &quot;千葉県&quot;=&gt;#&lt;Colorable::Color:0x007fbebb1e1708 @name=&quot;Bisque&quot;, @rgb=[255, 228, 196], @hex=nil, @hsb=nil, @esc=nil&gt;, ... , &quot;鹿児島県&quot;=&gt;#&lt;Colorable::Color:0x007fbebb1f3930 @name=&quot;Ghost White&quot;, @rgb=[248, 248, 255], @hex=nil, @hsb=nil, @esc=nil&gt;}</span>
</code></pre></div>


<h2>日本地図の描画</h2>

<p>さて、下準備ができました。gvizを使って日本地図を描画します。<code>graph.ru</code>ファイルを作って次のようなコードを書きます。</p>

<div class="highlight"><pre><code class="ruby"><span class="c1"># encoding: UTF-8</span>
<span class="nb">require</span> <span class="s2">&quot;./city&quot;</span>

<span class="n">global</span> <span class="ss">layout</span><span class="p">:</span><span class="s1">&#39;neato&#39;</span><span class="p">,</span> <span class="ss">label</span><span class="p">:</span><span class="s1">&#39;Map of Japan&#39;</span><span class="p">,</span> <span class="ss">fontsize</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">16</span>
<span class="n">nodes</span> <span class="ss">shape</span><span class="p">:</span><span class="s1">&#39;circle&#39;</span><span class="p">,</span> <span class="ss">width</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="ss">style</span><span class="p">:</span><span class="s1">&#39;filled&#39;</span>
<span class="no">City</span><span class="o">.</span><span class="n">cities</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="o">[</span><span class="n">c</span><span class="o">.</span><span class="n">pref</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="o">[</span><span class="n">c</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">lon</span><span class="o">].</span><span class="n">zip</span><span class="p">(</span><span class="o">[</span><span class="no">City</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="no">City</span><span class="o">.</span><span class="n">lon_range</span><span class="o">]</span><span class="p">)</span>
                           <span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">val</span><span class="p">,</span> <span class="n">range</span><span class="o">|</span> <span class="n">val</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">100</span><span class="o">.</span><span class="n">.</span><span class="mi">10000</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">node</span> <span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_id</span><span class="p">,</span> <span class="ss">label</span><span class="p">:</span><span class="nb">name</span><span class="p">,</span> <span class="ss">pos</span><span class="p">:</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">lon</span><span class="si">}</span><span class="s2">,</span><span class="si">#{</span><span class="n">lat</span><span class="si">}</span><span class="s2">!&quot;</span>
<span class="k">end</span>

<span class="n">save</span> <span class="ss">:japan</span>
</code></pre></div>


<p>gvizで定義された<code>Numeric#norm</code>を使ってCityオブジェクトが持っている緯度・経度情報を、生成されるグラフサイズに合わせて正規化します。これは、normの第２引数を試行錯誤して最適値を見つけます。Graphvizにおけるノードの絶対位置指定にはpos属性を使います。</p>

<p>ターミナルでgvizコマンドを実行し、graphvizで生成された画像を開きます。</p>

<div class="highlight"><pre><code class="bash">% gviz
% open japan.dot
</code></pre></div>


<p>さあ、出力です。</p>

<p><img src="/assets/images/2013/03/japanmap_mono.png" alt="japan noshadow" /></p>

<p>おみごと！自画自賛！antlaboさんありがとう！</p>

<p>市町村役場の位置情報に基いて、私たちの国「日本」の姿かたちが描かれました。</p>

<h2>日本地図のカラー化</h2>

<p>前回同様、仕上げに色を付けます。</p>

<div class="highlight"><pre><code class="ruby"><span class="c1"># encoding: UTF-8</span>
<span class="nb">require</span> <span class="s2">&quot;./city&quot;</span>

<span class="n">global</span> <span class="ss">layout</span><span class="p">:</span><span class="s1">&#39;neato&#39;</span><span class="p">,</span> <span class="ss">label</span><span class="p">:</span><span class="s1">&#39;Map of Japan&#39;</span><span class="p">,</span> <span class="ss">fontsize</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span> <span class="ss">size</span><span class="p">:</span><span class="mi">16</span>
<span class="n">nodes</span> <span class="ss">shape</span><span class="p">:</span><span class="s1">&#39;circle&#39;</span><span class="p">,</span> <span class="ss">width</span><span class="p">:</span><span class="mi">1</span><span class="o">.</span><span class="mi">4</span><span class="p">,</span> <span class="ss">style</span><span class="p">:</span><span class="s1">&#39;filled&#39;</span>
<span class="no">City</span><span class="o">.</span><span class="n">cities</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="nb">name</span> <span class="o">=</span> <span class="o">[</span><span class="n">c</span><span class="o">.</span><span class="n">pref</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">].</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
  <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span> <span class="o">=</span> <span class="o">[</span><span class="n">c</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">lon</span><span class="o">].</span><span class="n">zip</span><span class="p">(</span><span class="o">[</span><span class="no">City</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="no">City</span><span class="o">.</span><span class="n">lon_range</span><span class="o">]</span><span class="p">)</span>
                           <span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">val</span><span class="p">,</span> <span class="n">range</span><span class="o">|</span> <span class="n">val</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">100</span><span class="o">.</span><span class="n">.</span><span class="mi">10000</span><span class="p">)</span> <span class="p">}</span>
<span class="o">+</span>  <span class="n">color</span> <span class="o">=</span> <span class="no">City</span><span class="o">.</span><span class="n">pref_colors</span><span class="o">[</span><span class="n">c</span><span class="o">.</span><span class="n">pref</span><span class="o">]</span>
<span class="o">+</span>  <span class="n">fcolor</span> <span class="o">=</span> <span class="n">color</span><span class="o">.</span><span class="n">dark?</span> <span class="p">?</span> <span class="s1">&#39;white&#39;</span> <span class="p">:</span> <span class="s1">&#39;black&#39;</span>
<span class="o">+</span>  <span class="n">node</span> <span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_id</span><span class="p">,</span> <span class="ss">label</span><span class="p">:</span><span class="nb">name</span><span class="p">,</span> <span class="ss">pos</span><span class="p">:</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">lon</span><span class="si">}</span><span class="s2">,</span><span class="si">#{</span><span class="n">lat</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">,</span> <span class="ss">fillcolor</span><span class="p">:</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">color</span><span class="o">.</span><span class="n">hex</span><span class="si">}</span><span class="s2">aa&quot;</span><span class="p">,</span> <span class="ss">fontcolor</span><span class="p">:</span><span class="n">fcolor</span>
<span class="k">end</span>

<span class="n">save</span> <span class="ss">:japan</span>
</code></pre></div>


<p>出力はこちら。</p>

<p><a href="/assets/images/2013/03/jpmap_svg2.html" title="Metro Map"><img src="/assets/images/2013/03/japanmap_color.png" alt="japan noshadow" /></a></p>

<p>図をクリックするとSVGの頁が開きますので、手動で拡大できます（FirefoxはSVGのZoomに対応していないようです）。</p>

<p>以下は、一部地域の拡大図です。</p>

<p>近畿地方。</p>

<p><img src="/assets/images/2013/03/japanmap_color_big1.png" alt="japan noshadow" /></p>

<p>関東地方。</p>

<p><img src="/assets/images/2013/03/japanmap_color_big2.png" alt="japan noshadow" /></p>

<p>九州地方。</p>

<p><img src="/assets/images/2013/03/japanmap_color_big3.png" alt="japan noshadow" /></p>

<p>Numeric#normの第２引数を調整することで、ノードの密度を調整出来ます。ちなみに、SVG出力は、<code>10..100</code>で生成しました。</p>

<p>今回は以上です。</p>

<p>enjoy!</p>

<div><script src='https://gist.github.com/5235218.js?file='></script>
<noscript><pre><code></code></pre></noscript></div>


<hr />

<p style='color:red'>=== Ruby関連電子書籍100円で好評発売中！ ===</p>


<p><a href="/books/" title="M'ELBORNE BOOKS">M'ELBORNE BOOKS</a></p>

<p><a href="/books/">
  <img src="/assets/images/2012/start_ruby.jpg" alt="start_ruby" style="width:200px" />
</a>
<a href="/books/">
  <img src="/assets/images/2013/02/ruby_object_cover.png" alt="ruby_object" style="width:200px" />
</a>
<a href="/books/">
  <img src="/assets/images/2013/03/ruby_trivia_cover.png" alt="trivia" style="width:200px" />
</a></p>

<hr />

<div class="footnotes">
    <ol>
        <li id='fn:1'>ヘッダーの名前を一部編集しました <a href='#fnref:1' rev='footnote'>↩</a></li>
    </ol>
</div>





    <div class="ad" id="topAdsense">
      <script type="text/javascript"><!--
      google_ad_client = "ca-pub-8790567277062819";
      /* foot */
      google_ad_slot = "7511276945";
      google_ad_width = 728;
      google_ad_height = 90;
      //-->
      </script>
      <script type="text/javascript"
      src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script>
    </div>

    <hr>
    <ul class="social_button inline">
      <li id="hatena">
  <a href="http://b.hatena.ne.jp/entry/http://melborne.github.io/2013/03/25/map-of-japan-2/" class="hatena-bookmark-button" data-hatena-bookmark-title="Graphvizで作る、私たちの国「日本」の今度こそ本当の姿かたち" data-hatena-bookmark-layout="horizontal" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" width="20" height="30" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
</li>

<li id="twitter">
  <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://melborne.github.io/2013/03/25/map-of-japan-2/" data-text="Graphvizで作る、私たちの国「日本」の今度こそ本当の姿かたち" data-via="merborne" data-lang="ja" data-size="" data-count="horizontal"></a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</li>

<li id="google">
  <link rel="canonical" href="http://melborne.github.io/2013/03/25/map-of-japan-2/" />
  <g:plusone size="medium"></g:plusone>
  
  <script type="text/javascript">
    window.___gcfg = {lang: 'ja'};
  
    (function() {
      var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
      po.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
  </script>
</li>

<li id="facebook">
  <div class="fb-like" data-href="http://melborne.github.io/2013/03/25/map-of-japan-2/" data-layout="button_count" data-send="false" data-width="150" data-show-faces="false"></div>
</li>

<li></li>




    </ul>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/2013/03/22/map-of-japan" title="Graphvizで作る、私たちの国「日本」の本当の姿かたち">&larr; Previous</a></li>
      
        <li><a href="/">Archive</a></li>
        <!--<li><a href="/archive.html">Archive</a></li>-->
      
        <li class="next"><a href="/2013/03/25/this-is-another-world-of-graphviz" title="これもまた、Graphvizなんです。">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'melborne'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  
  <div class="span3">
    <div id="bookAd">
      <a href="/books/">
        <!--<img src="/assets/images/2012/start_ruby.jpg" alt="start_ruby" />-->
        <!--<img src="/assets/images/2012/jekyll_cover.jpg" alt="jekyll" />-->
        <!--<img src="/assets/images/2012/ruby_parallel_cover.png" alt="ruby_parallel" />-->
        <!--<img src="/assets/images/2012/js_oop_cover.png" alt="js_oop" />-->
        <!--<img src="/assets/images/2012/rack_cover.png" alt="rack" />-->
        <!--<img src="/assets/images/2013/02/ruby_object_cover.png" alt="ruby_object" />-->
        <img src="/assets/images/2013/03/ruby_trivia_cover.png" alt="ruby_trivia" />
      </a>
      <p id="comment">100円で好評発売中！<br/><a href="/books/">M'ELBORNE BOOKS</a></p>
    </div>

    <hr />
    

    <ul class="social_button inline">
      <li id="hatena">
  <a href="http://b.hatena.ne.jp/entry/http://melborne.github.io/2013/03/25/map-of-japan-2/" class="hatena-bookmark-button" data-hatena-bookmark-title="Graphvizで作る、私たちの国「日本」の今度こそ本当の姿かたち" data-hatena-bookmark-layout="horizontal" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only.gif" alt="このエントリーをはてなブックマークに追加" width="20" height="30" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
</li>

<li id="twitter">
  <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://melborne.github.io/2013/03/25/map-of-japan-2/" data-text="Graphvizで作る、私たちの国「日本」の今度こそ本当の姿かたち" data-via="merborne" data-lang="ja" data-size="" data-count="horizontal"></a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</li>

<li id="google">
  <link rel="canonical" href="http://melborne.github.io/2013/03/25/map-of-japan-2/" />
  <g:plusone size="medium"></g:plusone>
  
  <script type="text/javascript">
    window.___gcfg = {lang: 'ja'};
  
    (function() {
      var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
      po.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
  </script>
</li>

<li id="facebook">
  <div class="fb-like" data-href="http://melborne.github.io/2013/03/25/map-of-japan-2/" data-layout="button_count" data-send="false" data-width="150" data-show-faces="false"></div>
</li>

<li></li>




    </ul>

    <div class="ad" id="sideAdsense">
      <script type="text/javascript"><!--
      google_ad_client = "ca-pub-8790567277062819";
      /* sidebar */
      google_ad_slot = "0672114662";
      google_ad_width = 160;
      google_ad_height = 600;
      //-->
      </script>
      <script type="text/javascript"
      src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
      </script>
    </div>
  </div>
</div>


      </div>

      <footer>
        <p><a rel="license" href="http://creativecommons.org/licenses/by-nc/2.1/jp/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc/2.1/jp/88x31.png" /></a>  kyoendo 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>        </p>
      </footer>

    </div> <!-- /container -->

    

    <script type="text/javascript">
      if (location.hostname != 'localhost') {
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-288751-18']);
        _gaq.push(['_trackPageview']);
  
        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
      };
    </script>

    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/ja_JP/all.js#xfbml=1";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>

    <script src="/assets/javascripts/jquery-1.7.2.min.js"></script>
    <script src="/assets/javascripts/lightbox.js"></script>

    <script type="text/javascript" src="https://gumroad.com/js/gumroad.js"></script>
  </body>
</html>

